<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Registration - Library Management</title>
  <style>
    :root {
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --bg: #f8fafc;
      --card: #ffffff
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent
    }

    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .register-container {
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 500px;
      padding: 40px;
      animation: slideUp 0.4s ease;
      max-height: 90vh;
      overflow-y: auto
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .logo {
      text-align: center;
      margin-bottom: 32px
    }

    .logo-icon {
      font-size: 48px;
      margin-bottom: 12px
    }

    .logo h1 {
      margin: 0;
      font-size: 28px;
      color: #1e293b
    }

    .logo p {
      margin: 8px 0 0;
      color: #64748b;
      font-size: 14px
    }

    .form-group {
      margin-bottom: 18px
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: #374151
    }

    .form-group label .required {
      color: #ef4444
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      font-size: 15px;
      transition: all 0.2s;
      background: #f8fafc
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      background: #fff
    }

    .form-group input::placeholder {
      color: #94a3b8
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px
    }

    @media (max-width:480px) {
      .form-row {
        grid-template-columns: 1fr
      }
    }

    .btn-register {
      width: 100%;
      background: var(--accent);
      color: #fff;
      padding: 14px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s;
      margin-top: 8px
    }

    .btn-register:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3)
    }

    .btn-register:active {
      transform: translateY(0)
    }

    .btn-register:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none
    }

    .links {
      text-align: center;
      margin-top: 24px
    }

    .links a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px
    }

    .links a:hover {
      text-decoration: underline
    }

    .links p {
      margin: 12px 0;
      color: #64748b;
      font-size: 14px
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none
    }

    .success {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none
    }

    .password-strength {
      margin-top: 8px;
      height: 4px;
      background: #e2e8f0;
      border-radius: 2px;
      overflow: hidden
    }

    .password-strength-bar {
      height: 100%;
      width: 0;
      transition: all 0.3s;
      background: #ef4444
    }

    .password-hint {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
      color: #64748b;
      font-size: 14px
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e2e8f0
    }

    .divider::before {
      margin-right: 12px
    }

    .divider::after {
      margin-left: 12px
    }

    .btn-google {
      width: 100%;
      background: #fff;
      color: #1f2937;
      padding: 14px;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 8px
    }

    .btn-google:hover {
      border-color: var(--accent);
      background: #f8fafc;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1)
    }

    .btn-google:active {
      transform: translateY(0)
    }

    .btn-google img {
      width: 20px;
      height: 20px
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>

<body>
  <div class="register-container">
    <div class="logo">
      <div class="logo-icon">ðŸ“š</div>
      <h1>Create Account</h1>
      <p>Register to access the library</p>
    </div>

    <div id="errorMsg" class="error"></div>
    <div id="successMsg" class="success"></div>

    <button type="button" class="btn-google" id="googleSignInBtn">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M19.6 10.227c0-.709-.064-1.39-.182-2.045H10v3.868h5.382a4.6 4.6 0 01-1.996 3.018v2.51h3.232c1.891-1.742 2.982-4.305 2.982-7.35z"
          fill="#4285F4" />
        <path
          d="M10 20c2.7 0 4.964-.895 6.618-2.423l-3.232-2.509c-.895.6-2.04.955-3.386.955-2.605 0-4.81-1.76-5.595-4.123H1.064v2.59A9.996 9.996 0 0010 20z"
          fill="#34A853" />
        <path d="M4.405 11.9a6.015 6.015 0 010-3.8V5.51H1.064a9.996 9.996 0 000 8.98L4.405 11.9z" fill="#FBBC04" />
        <path
          d="M10 3.977c1.468 0 2.786.505 3.823 1.496l2.868-2.868C14.959.99 12.696 0 10 0 6.09 0 2.71 2.24 1.064 5.51l3.34 2.59C5.192 5.737 7.396 3.977 10 3.977z"
          fill="#EA4335" />
      </svg>
      Sign up with Google
    </button>

    <div class="divider">or sign up with email</div>

    <form id="registerForm">
      <div class="form-group">
        <label for="name">Full Name <span class="required">*</span></label>
        <input type="text" id="name" placeholder="Enter your full name" required />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="roll">Roll Number <span class="required">*</span></label>
          <input type="text" id="roll" placeholder="e.g., 2024001" required />
        </div>

        <div class="form-group">
          <label for="serialNo">Serial No. <span class="required">*</span></label>
          <input type="text" id="serialNo" placeholder="e.g., SN-001" required />
        </div>
      </div>

      <div class="form-group">
        <label for="jisuId">JISU ID <span class="required">*</span></label>
        <input type="text" id="jisuId" placeholder="Enter your JISU ID" required />
      </div>

      <div class="form-group">
        <label for="email">Email Address <span class="required">*</span></label>
        <input type="email" id="email" placeholder="your.email@example.com" required />
      </div>

      <div class="form-group">
        <label for="password">Password <span class="required">*</span></label>
        <input type="password" id="password" placeholder="Create a strong password" required minlength="6" />
        <div class="password-strength">
          <div class="password-strength-bar" id="strengthBar"></div>
        </div>
        <div class="password-hint">Minimum 6 characters</div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
        <input type="password" id="confirmPassword" placeholder="Re-enter your password" required />
      </div>

      <button type="submit" class="btn-register" id="submitBtn">Create Account</button>
    </form>

    <div class="links">
      <p>Already have an account? <a href="login.html">Login here</a></p>
    </div>
  </div>

  <script>
    const registerForm = document.getElementById('registerForm');
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');
    const submitBtn = document.getElementById('submitBtn');
    const passwordInput = document.getElementById('password');
    const strengthBar = document.getElementById('strengthBar');
    const googleSignInBtn = document.getElementById('googleSignInBtn');

    // Password strength indicator
    passwordInput.addEventListener('input', () => {
      const password = passwordInput.value;
      let strength = 0;

      if (password.length >= 6) strength += 25;
      if (password.length >= 10) strength += 25;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
      if (/[0-9]/.test(password)) strength += 25;

      strengthBar.style.width = strength + '%';

      if (strength < 50) strengthBar.style.background = '#ef4444';
      else if (strength < 75) strengthBar.style.background = '#f59e0b';
      else strengthBar.style.background = '#10b981';
    });

    // Google Sign-In
    googleSignInBtn.addEventListener('click', async () => {
      try {
        googleSignInBtn.disabled = true;
        googleSignInBtn.textContent = 'Signing in...';

        const result = await auth.signInWithPopup(googleProvider);
        const user = result.user;

        // Check if user already exists in Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();

        if (!userDoc.exists) {
          // New user - need to collect additional info
          showError('Google Sign-In successful! Please complete your profile by filling the registration form.');
          googleSignInBtn.disabled = false;
          googleSignInBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.6 10.227c0-.709-.064-1.39-.182-2.045H10v3.868h5.382a4.6 4.6 0 01-1.996 3.018v2.51h3.232c1.891-1.742 2.982-4.305 2.982-7.35z" fill="#4285F4"/>
            <path d="M10 20c2.7 0 4.964-.895 6.618-2.423l-3.232-2.509c-.895.6-2.04.955-3.386.955-2.605 0-4.81-1.76-5.595-4.123H1.064v2.59A9.996 9.996 0 0010 20z" fill="#34A853"/>
            <path d="M4.405 11.9a6.015 6.015 0 010-3.8V5.51H1.064a9.996 9.996 0 000 8.98L4.405 11.9z" fill="#FBBC04"/>
            <path d="M10 3.977c1.468 0 2.786.505 3.823 1.496l2.868-2.868C14.959.99 12.696 0 10 0 6.09 0 2.71 2.24 1.064 5.51l3.34 2.59C5.192 5.737 7.396 3.977 10 3.977z" fill="#EA4335"/>
          </svg>Sign up with Google`;

          // Pre-fill name and email
          document.getElementById('name').value = user.displayName || '';
          document.getElementById('email').value = user.email || '';
          document.getElementById('email').disabled = true;
        } else {
          // Existing user - redirect to dashboard
          showSuccess('Signed in successfully! Redirecting...');
          setTimeout(() => {
            window.location.href = 'user.html';
          }, 1500);
        }
      } catch (error) {
        console.error('Google Sign-In Error:', error);
        showError(error.message || 'Failed to sign in with Google. Please try again.');
        googleSignInBtn.disabled = false;
        googleSignInBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19.6 10.227c0-.709-.064-1.39-.182-2.045H10v3.868h5.382a4.6 4.6 0 01-1.996 3.018v2.51h3.232c1.891-1.742 2.982-4.305 2.982-7.35z" fill="#4285F4"/>
          <path d="M10 20c2.7 0 4.964-.895 6.618-2.423l-3.232-2.509c-.895.6-2.04.955-3.386.955-2.605 0-4.81-1.76-5.595-4.123H1.064v2.59A9.996 9.996 0 0010 20z" fill="#34A853"/>
          <path d="M4.405 11.9a6.015 6.015 0 010-3.8V5.51H1.064a9.996 9.996 0 000 8.98L4.405 11.9z" fill="#FBBC04"/>
          <path d="M10 3.977c1.468 0 2.786.505 3.823 1.496l2.868-2.868C14.959.99 12.696 0 10 0 6.09 0 2.71 2.24 1.064 5.51l3.34 2.59C5.192 5.737 7.396 3.977 10 3.977z" fill="#EA4335"/>
        </svg>Sign up with Google`;
      }
    });

    // Email/Password Registration
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const roll = document.getElementById('roll').value.trim();
      const serialNo = document.getElementById('serialNo').value.trim();
      const jisuId = document.getElementById('jisuId').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validation
      if (!name || !roll || !serialNo || !jisuId || !email || !password) {
        showError('Please fill in all required fields');
        return;
      }

      if (password.length < 6) {
        showError('Password must be at least 6 characters long');
        return;
      }

      if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating Account...';

      try {
        // Check if roll number, serial number, or JISU ID already exists
        const usersSnapshot = await db.collection('users').get();
        const existingUsers = usersSnapshot.docs.map(doc => doc.data());

        if (existingUsers.some(u => u.roll === roll)) {
          showError('Roll number already registered.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create Account';
          return;
        }

        if (existingUsers.some(u => u.serialNo === serialNo)) {
          showError('Serial number already registered.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create Account';
          return;
        }

        if (existingUsers.some(u => u.jisuId === jisuId)) {
          showError('JISU ID already registered.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create Account';
          return;
        }

        // Create Firebase Authentication user
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Update display name
        await user.updateProfile({
          displayName: name
        });

        // Store additional user data in Firestore
        await db.collection('users').doc(user.uid).set({
          name: name,
          roll: roll,
          serialNo: serialNo,
          jisuId: jisuId,
          email: email,
          memberSince: new Date().toISOString().split('T')[0],
          borrowed: [],
          history: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showSuccess('Account created successfully! Redirecting to login...');

        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);

      } catch (error) {
        console.error('Registration Error:', error);

        let errorMessage = 'Registration failed. Please try again.';
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = 'Email already registered. Please login or use a different email.';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'Invalid email address.';
        } else if (error.code === 'auth/weak-password') {
          errorMessage = 'Password is too weak. Please use a stronger password.';
        } else if (error.message) {
          errorMessage = error.message;
        }

        showError(errorMessage);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Account';
      }
    });

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';
      successMsg.style.display = 'none';
      setTimeout(() => {
        errorMsg.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      successMsg.textContent = message;
      successMsg.style.display = 'block';
      errorMsg.style.display = 'none';
    }
  </script>
</body>

</html>